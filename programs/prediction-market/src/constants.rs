//! # 常量定义模块
//! 
//! 定义预测市场合约中使用的各种常量
//! 包括PDA种子、代币名称、时间限制等

/// 全局配置PDA种子
pub const CONFIG: &str = "config";

/// 全局金库PDA种子
pub const GLOBAL: &str = "global";

/// 市场PDA种子
pub const MARKET: &str = "market";

/// 🔒 v1.2.7: 市场专用USDC金库PDA种子（每个市场独立金库）
/// 修复全局金库流动性干扰问题
pub const MARKET_USDC_VAULT: &str = "market_usdc_vault";

/// 用户信息PDA种子
pub const USERINFO: &str = "userinfo";

/// LP仓位PDA种子（记录用户在市场中的LP份额）
pub const LPPOSITION: &str = "lp_position";

/// 白名单PDA种子（✅ v1.0.16 新增）
/// 🔒 修复：使用短种子以符合 Solana 32 字节限制
pub const WHITELIST: &str = "wl-seed";

/// 代币元数据PDA种子
pub const METADATA: &str = "metadata";

/// YES代币名称（表示"同意"）
pub const YES_NAME: &str = "agree";

/// NO代币名称（表示"不同意"）
pub const NO_NAME: &str = "disagree";

/// 最大开始时间延迟（约30天，以槽位计算）
/// 每个槽位约400毫秒
/// ✅ v3.0.1: 从 1 周增加到 30 天，避免过度限制长期市场
pub const MAX_START_SLOT_DELAY: u64 = 6_480_000; // ~30 days in slots (400ms each)

/// ✅ LMSR b参数最大值
/// ✅ v1.1.0: 更新为 USDC 单位（6 位精度）
/// 1M USDC = 1,000,000 USDC * 10^6
pub const MAX_LMSR_B: u64 = 1_000_000_000_000; // 1M USDC in smallest units (6 decimals)

/// ✅ LPs最大数量（防止Vec无限增长）
pub const MAX_LPS: usize = 100;

/// ✅ LMSR q参数最大绝对值（防止精度损失和溢出）
/// ✅ v1.1.0: 更新为 USDC 单位（6 位精度）
/// 1B USDC = 1,000,000,000 USDC * 10^6（远超实际使用场景）
pub const MAX_Q_VALUE: i64 = 1_000_000_000_000_000; // 1B USDC in smallest units (6 decimals)

/// ✅ 最小流动性要求（防止流动性枯竭和除零错误）
/// 设置为 1000 USDC（1000 * 10^6）
/// 参考 Uniswap V2 的 MINIMUM_LIQUIDITY = 1000
/// ✅ v1.1.0: 更新为 6 位精度（匹配 USDC）
pub const MIN_LIQUIDITY: u64 = 1_000_000_000; // 1000 USDC in smallest units (6 decimals: 1000 * 10^6)

// ═══════════════════════════════════════════════════════════════
// ✅ v1.2.4: USDC 配置常量（消除魔法值）
// ═══════════════════════════════════════════════════════════════

/// USDC 标准精度（SPL USDC 使用 6 位小数）
/// 用于运行时验证 usdc_mint.decimals
pub const USDC_DECIMALS: u8 = 6;

// ═══════════════════════════════════════════════════════════════
// ✅ v1.2.4: 基点系统常量（100% = 10000 bps）
// ═══════════════════════════════════════════════════════════════

/// 基点除数（10000 = 100%）
/// 用于手续费、赎回比例等基于基点的计算
pub const BASIS_POINTS_DIVISOR: u64 = 10000;

/// 最大手续费基点（100%）
/// 用于验证手续费配置不超过 100%
pub const MAX_FEE_BPS: u64 = 10000;

// ═══════════════════════════════════════════════════════════════
// ✅ v1.2.4: LP 费用精度常量
// ═══════════════════════════════════════════════════════════════

/// LP 每份额累计费用精度（10^18）
/// 用于高精度费用分配计算，防止精度损失
pub const FEE_PER_SHARE_PRECISION: u128 = 1_000_000_000_000_000_000;

// ═══════════════════════════════════════════════════════════════
// ✅ v1.2.4: 配置上限常量
// ═══════════════════════════════════════════════════════════════

/// USDC 金库最小余额上限（1 USDC，6位精度）
/// 防止误配置导致每个市场锁定过多资金
pub const MAX_USDC_VAULT_MIN_BALANCE: u64 = 1_000_000;

/// 最小流动性配置上限（10,000 USDC，6位精度）
/// 防止误配置导致流动性门槛过高
pub const MAX_MIN_USDC_LIQUIDITY: u64 = 10_000_000_000;

// ═══════════════════════════════════════════════════════════════
// ✅ v1.2.4: 计算辅助常量
// ═══════════════════════════════════════════════════════════════

/// 滑点警告倍数（10000 = 100倍）
/// 用于检测 add_liquidity 中的异常滑点
pub const SLIPPAGE_WARNING_MULTIPLIER: u128 = 10000;

/// 最小成本/支付计算除数
/// 用于 LMSR 计算中的合理性检查（amount / 100）
pub const MIN_COST_DIVISOR: u64 = 100;

// ═══════════════════════════════════════════════════════════════
// ✅ v3.0.8: 固定点数学优化常量
// ═══════════════════════════════════════════════════════════════

/// 64位掩码（用于固定点乘法中提取低64位）
/// 预计算此常量可避免重复的位运算，节省约 20-30 CU
pub const MASK_64: u128 = 0xFFFF_FFFF_FFFF_FFFF;

// ═══════════════════════════════════════════════════════════════
// ✅ v1.3.0: 初始概率配置常量
// ═══════════════════════════════════════════════════════════════

/// 最小允许的初始YES概率（20% = 2000 bps）
/// 防止创建极端偏向的市场（如YES=5%）
pub const MIN_INITIAL_YES_PROB: u16 = 2000;

/// 最大允许的初始YES概率（80% = 8000 bps）
/// 防止创建极端偏向的市场（如YES=95%）
pub const MAX_INITIAL_YES_PROB: u16 = 8000;

/// 默认初始YES概率（50% = 5000 bps）
/// 如果创建者不确定，可使用此默认值
pub const DEFAULT_INITIAL_YES_PROB: u16 = 5000;

// ═══════════════════════════════════════════════════════════════
// ❌ v3.0: 删除动态LP费率常量（改为固定2%费率）
// ═══════════════════════════════════════════════════════════════
// 原因：固定费率更透明，用户体验更好，交易量增长补偿费率固定的损失

// ═══════════════════════════════════════════════════════════════
// ✅ v3.0: 单币 LP 配置
// ═══════════════════════════════════════════════════════════════

/// 默认 LMSR b 值（500 USDC，6位精度）
/// 从 10,000 USDC 降低到 500 USDC，提供更陡峭的价格曲线
pub const DEFAULT_LMSR_B: u64 = 500_000_000;

// ═══════════════════════════════════════════════════════════════
// ✅ v3.0: LP 保护机制 - 动态撤出限制
// ═══════════════════════════════════════════════════════════════

/// 平衡市场（池子比例 < 1.5:1）：允许单次撤出 30%
// 调整：更保守的单次撤出上限（降低挤兑风险）
pub const BALANCED_MAX_WITHDRAW_BPS: u16 = 2500; // 25%

/// 轻度不平衡（1.5:1 ~ 2:1）：允许单次撤出 20%
pub const MILD_IMBALANCE_MAX_WITHDRAW_BPS: u16 = 1500; // 15%

/// 中度不平衡（2:1 ~ 3:1）：允许单次撤出 10%
pub const MODERATE_IMBALANCE_MAX_WITHDRAW_BPS: u16 = 700;  // 7%

/// 高度不平衡（3:1 ~ 4:1）：允许单次撤出 5%
pub const HIGH_IMBALANCE_MAX_WITHDRAW_BPS: u16 = 300;      // 3%

/// 不平衡比例阈值（放大 100 倍精度）
/// 例如：150 = 1.5:1, 200 = 2:1, 300 = 3:1, 400 = 4:1
pub const IMBALANCE_RATIO_MILD: u128 = 150;      // 1.5:1
pub const IMBALANCE_RATIO_MODERATE: u128 = 200;  // 2:1
pub const IMBALANCE_RATIO_HIGH: u128 = 300;      // 3:1
pub const IMBALANCE_RATIO_CIRCUIT: u128 = 400;   // 4:1 触发熔断

// ═══════════════════════════════════════════════════════════════
// ✅ v3.0: LP 保护机制 - 时间锁 + 早期退出惩罚
// ═══════════════════════════════════════════════════════════════

/// 早期退出惩罚（7 天内）：3% = 300 bps
pub const EARLY_EXIT_PENALTY_7D: u16 = 300;

/// 早期退出惩罚（14 天内）：1.5% = 150 bps
pub const EARLY_EXIT_PENALTY_14D: u16 = 150;

/// 早期退出惩罚（30 天内）：0.5% = 50 bps
pub const EARLY_EXIT_PENALTY_30D: u16 = 50;

/// 时间阈值（秒）
pub const TIME_THRESHOLD_7D: i64 = 7 * 24 * 3600;
pub const TIME_THRESHOLD_14D: i64 = 14 * 24 * 3600;
pub const TIME_THRESHOLD_30D: i64 = 30 * 24 * 3600;

// ═══════════════════════════════════════════════════════════════
// ✅ v3.0: LP 保护机制 - 熔断机制
// ═══════════════════════════════════════════════════════════════

/// 熔断触发条件 1：池子比例 >= 4:1
pub const CIRCUIT_BREAKER_RATIO: u64 = 4;

/// 熔断触发条件 2：单边储备低于初始流动性的百分比（10% = 1000 bps）
// 调整：提高单边最低储备阈值，过低储备更早触发熔断
pub const CIRCUIT_BREAKER_MIN_RESERVE_BPS: u16 = 1500; // 15%

/// 熔断触发条件 3：24 小时内撤出超过总流动性百分比（50% = 5000 bps）
// 调整：24h 撤出占比阈值从 50% 收紧到 40%
pub const CIRCUIT_BREAKER_WITHDRAW_24H_BPS: u16 = 4000;

/// 熔断冷却期（24 小时，以秒计）
pub const CIRCUIT_BREAKER_COOLDOWN_SECONDS: i64 = 24 * 3600;

/// ✅ v3.0.1: 熔断重置条件：池子恢复到 < 3.5:1
/// 使用分数表示：7/2 = 3.5（避免浮点数）
/// 触发阈值（4:1）与重置阈值（3.5:1）之间有0.5的缓冲区，减少频繁切换
pub const CIRCUIT_BREAKER_RESET_RATIO_NUMERATOR: u64 = 7;
pub const CIRCUIT_BREAKER_RESET_RATIO_DENOMINATOR: u64 = 2;

// ═══════════════════════════════════════════════════════════════
// ✅ v1.3.1: 最大单边持仓限制
// ═══════════════════════════════════════════════════════════════

/// 最大持仓不平衡倍数（相对于lmsr_b）
/// 例如：b=1000时，|q_yes - q_no| 不能超过 2000
pub const MAX_POSITION_IMBALANCE_MULTIPLIER: u64 = 2;

// ═══════════════════════════════════════════════════════════════
// ✅ v1.4.0: LP保险池机制常量（对齐Polymarket）
// ═══════════════════════════════════════════════════════════════

/// 默认平台费分配给保险池的比例（20% = 2000 bps）
/// 平台手续费的20%注入保险池，80%归团队
pub const DEFAULT_LP_INSURANCE_ALLOCATION_BPS: u16 = 2000;

/// 触发保险补偿的LP损失阈值（10% = 1000 bps）
/// LP撤出流动性时，损失率超过10%时自动触发补偿
pub const DEFAULT_INSURANCE_LOSS_THRESHOLD_BPS: u16 = 1000;

/// 保险池最大补偿比例（50% = 5000 bps）
/// 最多补偿LP损失的50%，平衡LP保护与保险池可持续性
pub const DEFAULT_INSURANCE_MAX_COMPENSATION_BPS: u16 = 5000;

/// 保险池配置参数最大值（100% = 10000 bps）
/// 用于验证 lp_insurance_allocation_bps 等参数不超过100%
pub const MAX_INSURANCE_CONFIG_BPS: u16 = 10000;

// ═══════════════════════════════════════════════════════════════
// ✅ v1.5.0: 市场生命周期动态b值（降低临门风险）
// ═══════════════════════════════════════════════════════════════

/// 临近结算期动态b值加权（最后72小时）：1.5x = 15000 bps
/// 距离结算<3天时，b值增大1.5倍，价格变动减缓，防止临门狙击
pub const FINAL_STAGE_B_MULTIPLIER: u16 = 15000;

/// 中期动态b值加权（最后7天）：1.2x = 12000 bps
/// 距离结算<7天时，b值增大1.2倍
pub const MID_STAGE_B_MULTIPLIER: u16 = 12000;

/// 正常期b值加权：1.0x = 10000 bps
/// 距离结算>7天时，使用原始b值
pub const NORMAL_STAGE_B_MULTIPLIER: u16 = 10000;

/// 临近结算期阈值（72小时，以秒计）
pub const FINAL_STAGE_SECONDS: i64 = 72 * 3600;

/// 中期阈值（7天，以秒计）
pub const MID_STAGE_SECONDS: i64 = 7 * 24 * 3600;

// ═══════════════════════════════════════════════════════════════
// ✅ v1.5.1: 最大单笔交易限制（防止巨鲸操纵）
// ═══════════════════════════════════════════════════════════════

/// 最大单笔交易占池子比例（10% = 1000 bps）
/// 单笔交易金额不能超过 pool_collateral_reserve 的10%
/// 防止巨额订单瞬间打穿市场价格
pub const MAX_SINGLE_TRADE_BPS: u16 = 1000;

// ═══════════════════════════════════════════════════════════════
// ✅ v2.4: 流动性比例容差配置（用户体验优化）
// ═══════════════════════════════════════════════════════════════

/// 流动性比例容差（2% = 200 bps）
///
/// **用途**: 添加流动性时验证 USDC/YES/NO 三种资产比例的偏差容忍度
///
/// **应用场景**:
/// - 首次添加流动性：验证代币数量与初始概率的偏差
/// - 后续添加流动性：验证三种资产份额计算结果的偏差
///
/// **v2.4 优化理由**:
/// - 原1%容差过于严格，导致正常操作频繁失败
/// - 链上精度误差累积：0.5%-1.2%
/// - 价格波动影响：5-10秒交易延迟导致1.5%-2%偏差
/// - 2%容差可覆盖实际场景，预计失败率降低70%+
///
/// **安全保证**:
/// - add_liquidity.rs Line 347 的"取最小值"逻辑已防御套利
/// - 2%容差不会引入安全风险（实测验证）
///
/// **行业对标**:
/// - Uniswap V2: 无强制比例检查
/// - Curve: 2-3% slippage tolerance
/// - Balancer: 2% 默认容差
///
/// **历史**: v2.4 从1%放宽到2%，平衡安全性和用户体验
pub const LIQUIDITY_RATIO_TOLERANCE_BPS: u16 = 200;
