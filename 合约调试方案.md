# 🔍 合约调试方案

## 🎯 问题

前端一直报错：`InvalidParameter` 在第 87 行

第 87 行的检查是：
```rust
require!(
    new_config.token_decimals_config == crate::constants::USDC_DECIMALS,
    InvalidParameter
);
```

这意味着传入的 `token_decimals_config` 不等于 6。

---

## ✅ 已添加调试日志

我已经在合约代码中添加了调试日志：

```rust
msg!("🔍 Debug: token_decimals_config = {}", new_config.token_decimals_config);
msg!("🔍 Debug: USDC_DECIMALS = {}", crate::constants::USDC_DECIMALS);
msg!("🔍 Debug: authority = {}", new_config.authority);
msg!("🔍 Debug: team_wallet = {}", new_config.team_wallet);
msg!("🔍 Debug: platform_buy_fee = {}", new_config.platform_buy_fee);
```

---

## 📋 重新部署合约的步骤

### 步骤 1: 构建合约

```bash
cd contract
anchor build
```

### 步骤 2: 部署合约

```bash
anchor deploy --provider.cluster devnet
```

### 步骤 3: 更新前端 Program ID

如果 Program ID 改变了，需要更新前端：

```typescript
// x402-polymarket-frontend/app/lib/solana/program.ts
export const PROGRAM_CONFIG = {
  programId: new PublicKey('新的_PROGRAM_ID'),
  // ...
};
```

### 步骤 4: 重新尝试初始化

访问前端并尝试初始化，这次会看到详细的日志。

---

## 🔍 查看日志

### 方法 1: 在浏览器控制台

当交易失败时，错误对象中会包含 `logs` 字段：

```javascript
catch (err) {
  console.error('Error:', err);
  if (err.logs) {
    console.log('Program logs:', err.logs);
  }
}
```

### 方法 2: 使用 Solana Explorer

1. 复制交易签名
2. 访问：https://explorer.solana.com/tx/[签名]?cluster=devnet
3. 查看 "Program Instruction Logs"

### 方法 3: 使用 Solana CLI

```bash
solana confirm -v [交易签名] --url devnet
```

---

## 🐛 可能的问题

### 问题 1: 字段顺序错误

Anchor 序列化时可能对字段顺序敏感。

**解决**: 确保前端传递的对象字段顺序与 Rust 结构体定义完全一致。

### 问题 2: 类型转换错误

JavaScript 的 `6` 可能被错误地序列化。

**解决**: 确保使用正确的类型：
```typescript
token_decimals_config: 6  // number, not string
```

### 问题 3: 缺少字段

如果某个字段缺失，反序列化会失败。

**解决**: 确保所有 23 个字段都存在。

### 问题 4: BN 类型问题

某些字段可能需要特定的 BN 格式。

**解决**: 检查所有 u64 字段是否使用了 `new BN()`。

---

## 💡 临时绕过方案

如果重新部署合约太麻烦，可以尝试：

### 方案 A: 修改合约，移除这个检查

**不推荐**，因为这个检查是有意义的。

### 方案 B: 使用已部署的合约

如果有其他已经初始化的合约实例，可以直接使用。

### 方案 C: 等待调试日志

重新部署合约后，日志会告诉我们确切的问题。

---

## 🎯 推荐方案

### 最快的方法：检查前端代码

在前端添加更详细的日志：

```typescript
console.log('=== 配置参数详情 ===');
console.log('token_decimals_config:', configParams.token_decimals_config);
console.log('  类型:', typeof configParams.token_decimals_config);
console.log('  值:', configParams.token_decimals_config);
console.log('  === 6?', configParams.token_decimals_config === 6);
console.log('  === "6"?', configParams.token_decimals_config === "6");

// 检查所有字段
Object.keys(configParams).forEach(key => {
  const value = configParams[key];
  console.log(`${key}:`, value, `(${typeof value})`);
});
```

---

## 📊 调试检查清单

- [ ] `token_decimals_config` 的值是 `6`
- [ ] `token_decimals_config` 的类型是 `number`
- [ ] 所有 23 个字段都存在
- [ ] 字段顺序与 IDL 一致
- [ ] u64 字段使用了 `new BN()`
- [ ] u16/u8 字段使用了普通 number
- [ ] PublicKey 字段使用了 `PublicKey` 对象
- [ ] boolean 字段使用了 `true`/`false`

---

## 🚀 下一步

1. **在前端添加详细日志**（最快）
2. **刷新页面并重试**
3. **查看控制台输出**
4. **告诉我看到了什么**

或者：

1. **重新构建和部署合约**
2. **查看程序日志**
3. **找到确切的问题**

---

**建议先尝试前端日志，这样最快！** 🔍
